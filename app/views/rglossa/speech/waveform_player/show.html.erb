<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>SoundManager 2 Demo: Play MP3 links on a page, "page as playlist" style</title>
<meta name="robots" content="noindex" />

<!-- Page player core CSS -->
<%= stylesheet_link_tag ActionController::Base.helpers.asset_path("rglossa/speech/wfplayer.css") %>

<!-- soundManager.useFlashBlock: related CSS -->
<%= stylesheet_link_tag ActionController::Base.helpers.asset_path("rglossa/speech/wfplayer-flashblock.css") %>

<style type="text/css">
ul.playlist li .comment {font-size:0.65em;opacity:0.5}
</style>

<!-- soundManager API -->
<%= javascript_include_tag ActionController::Base.helpers.asset_path("rglossa/speech/soundmanager2-nodebug-jsmin.js") %>

<script>
  var total_width = <%= @total_imgwidth %>;

/* --------

  Config override: This demo uses shiny flash 9 stuff, overwriting Flash 8-based defaults
  Alternate PP_CONFIG object must be defined before soundManager.onready()/onload() fire.
  Alternately, edit the config in page-player.js to simply use the values below by default

-------- */
soundManager.setup({
  flashVersion: 9,
  preferFlash: !window.location.toString().match(/experimental/i), // for visualization effects
  debugMode: false,
  debugFlash: false,
  useHighPerformance: true, // keep flash on screen, boost performance
  wmode: 'transparent', // transparent SWF, if possible
  url: '<%= ActionController::Base.helpers.asset_path("rglossa/speech/") %>'
});

// custom page player configuration

var PP_CONFIG = {
  autoStart: true,      // begin playing first sound when page loads
  playNext: false,        // stop after one sound, or play through list until end
  allowRightClick: true,
  useThrottling: true,  // try to rate-limit potentially-expensive calls (eg. dragging position around)</span>
  usePeakData: true,     // [Flash 9 only] whether or not to show peak data (left/right channel values) - nor noticable on CPU
  useWaveformData: false,// [Flash 9 only] show raw waveform data - WARNING: LIKELY VERY CPU-HEAVY
  useEQData: false,      // [Flash 9 only] show EQ (frequency spectrum) data
  useFavIcon: false     // try to apply peakData to address bar (Firefox + Opera) - performance note: appears to make Firefox 3 do some temporary, heavy disk access/swapping/garbage collection at first(?) - may be too heavy on CPU
}

</script>

<!-- Page player main script -->
<%= javascript_include_tag ActionController::Base.helpers.asset_path("rglossa/speech/wfplayer.js") %>
<%= javascript_include_tag ActionController::Base.helpers.asset_path("jquery.min") %>

</head>

<body>
 <div id="debug"></div>
 <div id="bar"></div>
 <ul class="playlist" data-value="<%= @conf['output_dir'] %>">
  <li><span data-value="<%= @file %>"><div class="btn"><img src="<%= ActionController::Base.helpers.asset_path('rglossa/speech/play-pause.png') %>"></div>&nbsp;<div class="btn">Play / Pause</div></span></li>
 </ul>
 <%
   @basenames.zip(@imgwidths, (0..Float::INFINITY)).each do |basename, imgwidth, i|
     width = 100 * imgwidth / @total_imgwidth
   %><img id='small<%= i %>' src='<%= @conf['output_dir'] %>/<%= basename %>-wave.jpg' width='<%= width %>%' height='70' style='display:none'><%
   end
 %>
 <iframe id='iframe' height="237" width="100%" style="border: 0"></iframe>
<script type="text/javascript">
var scrollMode = false;
var doc = document.getElementById('iframe').contentWindow.document;
doc.open();
doc.write('<html><head><title></title></head><body style="margin: 0 0 0 0; overflow-y: hidden; width: <%= @total_imgwidth %>px">');
doc.write('<div id="bar" style="width: 2px; background-color: red; height: <%= @conf['total_height'] %>px; position: absolute; z-index: 3"></div>');
doc.write('<div id="sel-start" style="position: relative; z-index: 4; cursor: ew-resize"></div>');
doc.write('<div id="sel-stop" style="position: relative; z-index: 4; cursor: ew-resize"></div>');
doc.write('<div id="sel" style="position: relative; z-index: 3"></div>');
<% @basenames.zip(0..Float::INFINITY).each do |basename, i| %>
doc.write('<div style="position: relative; z-index: 0; float: left" id="waveform<%= i %>">');
doc.write('<img src="<%= @conf['output_dir'] %>/<%= basename %>-wave.jpg" class="wave">');
doc.write('<img src="<%= @conf['output_dir'] %>/<%= basename %>-fmt.png" style="position: absolute; z-index: 2; left: 0; top: 0" class="fmt">');
doc.write('<img src="<%= @conf['output_dir'] %>/<%= basename %>-pitch.png" style="position: absolute; z-index: 1; left: 0; top: 0" class="pitch"></div>');
<% end %>
doc.write('</body></html>');
doc.close();

getPos = function(oSound, event) {
  return Math.floor(oSound.duration*event.pageX/<%= @total_imgwidth %>)
};

selEdgeCss = {'width': '2px', 'height': '<%= @conf['total_height'] %>px', 'backgroundColor': 'blue',
              'position': 'absolute'};

doc.body.onmousedown = function(event) {
  scrollMode = true;
  $('#iframe').contents().find('#sel').css('visibility', 'hidden');
  oSound = pagePlayer.lastSound;
  oSound.startX = event.pageX;
  oSound.startPos = getPos(oSound, event);
  oSound.setPosition(oSound.startPos);
  oSound.stop();
  var selStartCss = $.extend({}, selEdgeCss, {'left': event.pageX});
  $('#iframe').contents().find('#sel-start').css(selStartCss);
  return false;
};

doc.body.onmousemove = function(event) {
  if (scrollMode) {
    var selStopCss = $.extend({}, selEdgeCss, {'left': event.pageX});
    var selCss = {'width': Math.abs(event.pageX-oSound.startX)+'px',
                  'height': '<%= @conf['total_height'] %>px',
                  'backgroundColor': 'rgba(0, 0, 0, 0.1)',
                  'left': Math.min(event.pageX, oSound.startX), 'position': 'absolute',
                  'visibility': 'visible'}
    $('#iframe').contents().find('#sel-stop').css(selStopCss);
    $('#iframe').contents().find('#sel').css(selCss);
  }
}

doc.body.onmouseup = function(event) {
  if (!scrollMode) return true;
  scrollMode = false;
  oSound = pagePlayer.lastSound;
  curPos = getPos(oSound, event);
  if (Math.abs(curPos - oSound.startPos) < 10) {
    oSound.startPos = Math.min(curPos, oSound.startPos);
    oSound.stopPos = Math.floor(oSound.duration);
  } else if (curPos < oSound.startPos) {
    oSound.stopPos = oSound.startPos;
    oSound.startPos = curPos;
  } else {
    oSound.stopPos = curPos;
  }
  var selStopCss = $.extend({}, selEdgeCss, {'left': event.pageX});
  $('#iframe').contents().find('#sel-stop').css(selStopCss);
  oSound.stop();
  oSound.setPosition(oSound.startPos);
  oSound.play();
};

toggleWaveform = function(id, cls) {
  if($(id).is(':checked')) {
    $('#iframe').contents().find(cls).css('visibility', 'visible');
  } else {
    $('#iframe').contents().find(cls).css('visibility', 'hidden')
  }
}

$(document).ready(function() {
  $('#wfcb').click(function() {
    toggleWaveform('#wfcb', '.wave');
  });
  $('#fmcb').click(function() {
    toggleWaveform('#fmcb', '.fmt');
  });
  $('#ptcb').click(function() {
    toggleWaveform('#ptcb', '.pitch');
  });
});
</script>
<form>
<label><input type="checkbox" id="wfcb" checked>waveform &amp; spectrogram</label> |
<label><input type="checkbox" id="fmcb" checked>formants:
  <span style="color: red">1</span> <span style="color: lightgreen">2</span>
  <span style="color: blue">3</span> <span style="color: orange">4</span></label> |
<label><input type="checkbox" id="ptcb" checked>pitch</label> |
Problems? Switch to
<script>

// enable experimental features, if #experimental is in the URL
if (window.location.toString().match(/experimental/i)) {
  document.write('<a href="#" onclick="window.location.href = this; window.location.reload()">Flash player</a>');
} else {
  document.write('<a href="#experimental" onclick="window.location.href = this; window.location.reload()">JavaScript player</a>');
}

var is_shiny = false;
function setTheme(sTheme) {
  var o = pagePlayer.getByClassName('playlist','ul');
  for (var i=o.length; i--;) {
    o[i].className = 'playlist'+(pagePlayer.cssBase?' '+pagePlayer.cssBase:'')+(sTheme?' '+sTheme:'')+(is_shiny?' shiny':'');
  }
  return false;
}

function setShiny(bShiny, e) {
  is_shiny = bShiny;
  var o = pagePlayer.getByClassName('playlist','ul');
  var sClass = 'shiny';
  for (var i=o.length; i--;) {
    if (!bShiny) {
      pagePlayer.removeClass(o[i],sClass);
    } else {
      pagePlayer.addClass(o[i],sClass);
    }
  }
}
</script>
</form>
</body>
</html>
